# LLM-generated Datasets Repairer

A comprehensive tool for detecting and repairing corrupted XML datasets generated by Large Language Models (LLMs). Originally designed for aspect-based sentiment analysis research with **SemEval XML format optimization**, but works with **general XML corruption patterns**.

## Overview

Large Language Models, while powerful for generating synthetic datasets, can introduce various inconsistencies and corruption patterns that make XML files malformed and unusable for research purposes. These issues arise due to:

- **Token limitations and context windows**: LLMs may truncate or split XML tags when approaching token limits
- **Training data inconsistencies**: Models may reproduce malformed patterns from their training data
- **Attention mechanisms**: Complex XML structures can cause models to lose track of proper nesting
- **Temperature settings**: Higher creativity settings can introduce structural irregularities
- **Fine-tuning artifacts**: Domain-specific fine-tuning may introduce systematic formatting errors

This tool automatically detects and repairs these LLM-induced corruption patterns while providing detailed logging of all changes made.

## Features

### ğŸ” **Corruption Detection Logic**

#### **What Gets Flagged as Corrupted:**
1. **Split Closing Tags**: Tag broken across lines
   - `</Opi` on one line, `nions>` on next line
   - Pattern: `</\w+$` (end-of-line closing tags without `>`)

2. **Malformed Opinion Tags**: Specific typos and malformations
   - `</O-pinions>` (hyphenated)
   - `</Opinces>` (typo)
   - `</Opinionss>` (double s)
   - `</Opin>`, `</Opini>`, `</Opinio>` (truncated)
   - **EXCLUDES**: Valid `</Opinion>` and `</Opinions>` tags

3. **Missing Attribute Spaces**: Concatenated attributes
   - `from="0"to="0"` â†’ `from="0" to="0"`
   - Pattern: `="[^"]*"[a-zA-Z]`

4. **Unmatched Sentence Tags**: Missing closing tags
   - Counts `<sentence id="...">` vs `</sentence>`
   - Reports difference as corruption count

5. **Invalid XML Characters**: Non-XML compliant characters
   - Control characters, invalid Unicode ranges
   - Pattern: Outside standard XML character ranges

6. **Malformed Attributes**: Specific attribute errors
   - `a category=` â†’ `category=`

#### **What Does NOT Get Flagged:**
- âœ… Valid SemEval XML structure (`<Reviews>`, `<Review>`, `<sentences>`, `<sentence>`)
- âœ… Proper `</Opinions>` and `</Opinion>` closing tags
- âœ… Correctly indented closing tags (`</sentences>`, `</Review>`)
- âœ… Standard XML attributes with proper spacing
- âœ… Valid XML declaration and encoding
- âœ… Nested structure following SemEval format

### ğŸ› ï¸ **Repair Capabilities**
- **Basic Corruption Fixes**: Merge split tags, fix typos, add missing spaces
- **Structural Reconstruction**: Rebuild proper XML hierarchy and nesting
- **Auto-completion**: Add missing closing tags where needed
- **Content Validation**: Remove orphaned content outside proper structure

### ğŸ“‹ **Detailed Logging**
- **Before/After Tracking**: Every change is logged with original and fixed content
- **Line-by-Line Changes**: Exact line numbers and modifications
- **Repair Statistics**: Comprehensive analysis of corruption patterns
- **Action Descriptions**: Human-readable explanations of each fix

### ğŸ’¾ **Data Safety**
- **Automatic Backups**: Original files are always preserved
- **Validation**: Repairs are validated using XML parser
- **Rollback Capability**: Easy to revert changes using backup files

## Installation

No external dependencies required! The tool uses only Python standard libraries.

```bash
# Clone or navigate to the datasets-repairer directory
cd datasets-repairer

# Optional: Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install (if requirements.txt exists in future)
pip install -r requirements.txt
```

## Quick Start

### Basic Usage

```bash
# Repair all XML files in a directory
python repair.py --directory /path/to/xml/files

# Repair a single file
python repair.py --file /path/to/file.xml

# Dry run (analyze without making changes)
python repair.py --directory /path/to/xml/files --dry-run

# Force repair even if files appear valid
python repair.py --directory /path/to/xml/files --force
```

### Using as Python Module

```python
from datasets_repairer import XMLRepairTool

# Create repair tool instance
repair_tool = XMLRepairTool()

# Repair a file
repair_stats = repair_tool.repair_file('/path/to/corrupted.xml')

# Check results
if repair_stats.success:
    print(f"âœ… File repaired successfully!")
    print(f"ğŸ“Š Fixed {len(repair_stats.repair_actions)} issues")
    print(f"ğŸ“„ Log saved to: {repair_stats.log_path}")
else:
    print(f"âŒ Repair failed")
```

## File Structure

```
datasets-repairer/
â”œâ”€â”€ __init__.py              # Module initialization
â”œâ”€â”€ repair_engine.py         # Core repair logic
â”œâ”€â”€ corruption_detector.py   # Corruption pattern detection
â”œâ”€â”€ repair.py               # Command-line interface
â”œâ”€â”€ README.md               # This file
â”œâ”€â”€ requirements.txt        # Dependencies (minimal)
â””â”€â”€ tests/                  # Unit tests (future)
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ test_repair_engine.py
    â””â”€â”€ test_data/
        â”œâ”€â”€ corrupted_samples/
        â””â”€â”€ expected_outputs/
```

## Output Files

For each repaired XML file, the tool generates:

### 1. **Backup File** (`filename.xml.original_backup`)
- Exact copy of the original file before any modifications
- Always created, even if no repairs are needed
- Use this to rollback changes if needed

### 2. **Repair Log** (`filename_repair_log.txt`)
- Detailed log of all changes made
- Before/after content for each modification
- Line numbers and descriptions
- Corruption pattern analysis
- Only created if repairs were actually made

### Example Repair Log:
```
================================================================================
XML REPAIR LOG
================================================================================
File: google-gemini2.5pro-700.xml
Repair Date: 2024-12-19 16:30:45
Original Size: 453,456 characters
Repaired Size: 453,892 characters
Size Change: +436 characters
Repair Success: âœ… YES
Backup Created: google-gemini2.5pro-700.xml.original_backup

CORRUPTION PATTERNS DETECTED:
----------------------------------------
Total Issues: 15
  malformed_opinions: 12
  missing_spaces: 3

DETAILED REPAIR ACTIONS:
----------------------------------------
Total Actions: 15

Action   1: Fix malformed closing tag
Line:        184
Description: Fixed typo in closing tag
Before:      '                </Opinces>'
After:       '                </Opinions>'
----------------------------------------
Action   2: Fix missing attribute space
Line:        561
Description: Added missing space between attributes
Before:      '    <Opinion target="NULL" category="FOOD#QUALITY"polarity="neutral" from="0" to="0"/>'
After:       '    <Opinion target="NULL" category="FOOD#QUALITY" polarity="neutral" from="0" to="0"/>'
----------------------------------------
...
```

## Command-Line Options

```bash
python repair.py [OPTIONS]

Options:
  -d, --directory PATH    Directory containing XML files to repair
  -f, --file PATH         Repair specific file instead of directory  
  --no-backup            Skip creating backup files
  --force                Repair all files, even if they appear valid
  --dry-run              Show what would be repaired without making changes
  --analyze-only         Only analyze corruption patterns, do not repair
  -v, --verbose          Show detailed output
  -h, --help             Show help message and exit
```

## Common Use Cases

### 1. **Pre-Experiment Validation**
```bash
# Check all datasets before running experiments
python repair.py --directory ../experiment_datasets/semeval_implitcits --dry-run
```

### 2. **Batch Dataset Repair**
```bash
# Repair all corrupted files in one go
python repair.py --directory ../experiment_datasets/semeval_implitcits
```

### 3. **Individual File Repair**
```bash
# Fix a specific problematic file
python repair.py --file ../experiment_datasets/semeval_implitcits/google-gemini2.5pro-700.xml
```

### 4. **Quality Assurance**
```bash
# Force check all files to ensure they're corruption-free
python repair.py --directory ../experiment_datasets/semeval_implitcits --force
```

## Detailed Corruption Patterns

| Pattern | Detection Logic | Example | Auto-Fix Available |
|---------|----------------|---------|-------------------|
| **Split closing tags** | `</\w+$` end-of-line without `>` | `</Opi`<br>`nions>` | âœ… Merges split tags |
| **Malformed opinion tags** | Specific typo patterns | `</Opinces>` â†’ `</Opinions>`<br>`</O-pinions>` â†’ `</Opinions>` | âœ… Fixes known typos |
| **Missing attribute spaces** | `="[^"]*"[a-zA-Z]` | `from="0"to="0"` â†’ `from="0" to="0"` | âœ… Adds missing spaces |
| **Malformed attributes** | `a category=` pattern | `a category=` â†’ `category=` | âœ… Removes extra characters |
| **Unmatched sentence tags** | Count mismatch | 840 `<sentence>` vs 700 `</sentence>` | âš ï¸ Partial (adds missing closing) |
| **Invalid XML characters** | Non-XML character ranges | Control chars, invalid Unicode | âœ… Removes invalid chars |

### **Important Notes:**
- âœ… **SemEval XML Structure**: Properly recognizes valid SemEval format
- âœ… **Valid Tags**: Does NOT flag `</Opinions>`, `</Opinion>`, `</sentences>` as corrupted
- âš ï¸ **Complex Issues**: Some severe corruption may require regeneration
- ğŸ“Š **Detection vs Repair**: Tool can detect more issues than it can automatically fix

## **Compatibility & Scope**

### **XML Format Compatibility:**
- ğŸ¯ **Primary Target**: SemEval XML format for aspect-based sentiment analysis
  - Optimized for `<Reviews>` â†’ `<Review>` â†’ `<sentences>` â†’ `<sentence>` â†’ `<Opinions>` structure
  - Recognizes opinion-specific patterns and prevents false positives
  
- ğŸŒ **General XML Support**: Works with any XML format for basic corruption patterns
  - Split closing tags, missing attribute spaces, invalid characters
  - Basic structural reconstruction and validation
  - Generic malformed tag detection

### **What Works Universally:**
- âœ… Split closing tags (`</tag` + `>` on next line)
- âœ… Missing attribute spaces (`attr="value"nextattr=`)
- âœ… Invalid XML characters and encoding issues
- âœ… Basic structural validation and reconstruction

### **What's SemEval-Optimized:**
- ğŸ¯ Opinion tag patterns (`</Opinions>`, `</Opinion>` recognition)
- ğŸ¯ Sentence tag counting and matching
- ğŸ¯ SemEval hierarchy validation
- ğŸ¯ Aspect-based sentiment analysis specific patterns

### **Usage for Other XML Formats:**
The tool will work on other XML formats, but may:
- Miss format-specific corruption patterns
- Have less precise detection for non-SemEval structures
- Provide generic rather than domain-specific repair suggestions

For maximum effectiveness with other XML formats, consider customizing the detection patterns in `corruption_detector.py`.

## Integration with Research Pipeline

This tool is designed to work seamlessly with aspect-based sentiment analysis research pipelines:

1. **Pre-processing**: Run before experiments to ensure clean datasets
2. **Post-generation**: Repair datasets immediately after LLM generation
3. **Continuous validation**: Check dataset integrity during development

### Typical Workflow:
```bash
# 1. Generate datasets using LLMs
cd ../datasets-generator
python generate_datasets.py

# 2. Repair any corruption
cd ../datasets-repairer
python repair.py --directory ../experiment_datasets/semeval_implitcits

# 3. Run experiments with clean data
cd ..
python run_experiments.py
```

## Performance

- **Speed**: Processes ~1MB XML files in under 1 second
- **Memory**: Low memory footprint, processes files line by line
- **Scalability**: Handles datasets with thousands of reviews
- **Reliability**: Extensive validation and error handling

## Error Handling

The tool handles various error conditions gracefully:

- **Encoding Issues**: Tries multiple encodings (UTF-8, Latin1, CP1252, UTF-16)
- **Permission Errors**: Clear error messages for file access issues
- **Severe Corruption**: Partial repairs with detailed reporting
- **Validation Failures**: Reports what couldn't be fixed

## Contributing

### Adding New Corruption Patterns

1. Add detection logic to `detect_corruption_patterns()`
2. Implement fix in `fix_basic_corruption()` or `reconstruct_xml_structure()`
3. Add test cases
4. Update documentation

### Testing

```bash
# Run unit tests (when implemented)
python -m pytest tests/

# Test on sample corrupted files
python repair.py --file tests/test_data/corrupted_samples/sample.xml --dry-run
```

## Troubleshooting

### Common Issues

**Q: Repair failed, file still shows XML errors**
A: Some corruption patterns may be too severe for automatic repair. Check the repair log for details and consider manual editing or regenerating the dataset.

**Q: Original file was overwritten**
A: Check for the `.original_backup` file in the same directory. This contains your original data.

**Q: Tool reports no issues but XML parser still fails**
A: Run with `--force` flag to attempt repairs even on files that appear valid.

### Getting Help

1. Check the repair log file for detailed information
2. Run with `--dry-run` to see what changes would be made
3. Examine the backup file to understand the original corruption
4. Review this README for supported corruption patterns

## Version History

- **v1.0.0**: Initial release with core repair functionality
  - Basic corruption pattern fixes
  - Structural reconstruction
  - Detailed logging and backup system
  - Command-line interface

## License

Part of the aspect-based sentiment analysis research project. See main project license for details.